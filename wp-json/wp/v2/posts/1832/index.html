{"id":1832,"date":"2019-12-06T12:09:49","date_gmt":"2019-12-06T17:09:49","guid":{"rendered":"https:\/\/ricardoromo.co\/?p=1832"},"modified":"2021-07-17T11:14:45","modified_gmt":"2021-07-17T16:14:45","slug":"crea-una-servidor-de-sala-de-chat-en-c-servidor","status":"publish","type":"post","link":"http:\/\/3.214.197.113\/2019\/crea-una-servidor-de-sala-de-chat-en-c-servidor\/","title":{"rendered":"Como crear una Sala de Chat en C &#8211; Servidor"},"content":{"rendered":"<div class='booster-block booster-read-block'>\r\n                <div class=\"twp-read-time\">\r\n                \t<i class=\"booster-icon twp-clock\"><\/i> <span>Tiempo de lectura:<\/span>4 Minutos, 32 Segundos                <\/div>\r\n\r\n            <\/div>\n<h2 class=\"has-text-align-center\">Creando el Servidor<\/h2>\n\n\n\n<div class=\"wp-block-uagb-buttons uagb-buttons__outer-wrap uagb-block-5fdb6650\"><div class=\"uagb-buttons__wrap uagb-buttons-layout-wrap\">\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-b5a9a82c\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c\/\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 1<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-4ba41ea4\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c-cliente\/\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 2<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-7a3ad012\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c-servidor\/\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 3<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-db99d418\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c-final\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 4<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-327b1626\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/github.com\/MrRomo\/C-Chatroom\" rel=\"noopener noreferrer\" target=\"_blank\"><div class=\"uagb-button__link\">Descargar c\u00f3digo<\/div><\/a><\/div><\/div>\n\n<\/div><\/div>\n\n\n\n<p class=\"has-text-align-justify\">El servidor en este proyecto, funciona como broker de mensajes, repartiendo los mensajes entre todos los clientes menos al emisor original. Es el encargado de decidir el puerto al cual se conectar\u00e1n los clientes.<\/p>\n\n\n\n<h3>Funciones:<\/h3>\n\n\n\n<p class=\"has-text-align-justify\">Este c\u00f3digo del servidor ya es m\u00e1s complejo, ya que tiene que lidiar con todos los clientes y reenviar los mensajes de los remitentes. Consta de las siguientes funciones, algunas se explican por s\u00ed solas, pero vamos a intentar darles una idea de para qu\u00e9 sirve cada una:<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">void print_client_addr(struct sockaddr_in addr);\nvoid queue_add(client_t *cl);\nvoid queue_remove(int uid);\nvoid send_message(char *s, int uid);\nvoid *handle_client(void *arg);\nint main(int argc, char **argv)\n<\/pre>\n\n\n\n<h3>Funci\u00f3n Main<\/h3>\n\n\n\n<p>Al igual que el c\u00f3digo del cliente, desde la funci\u00f3n main obtenemos el puerto al cual se va a configurar el servidor, la direcci\u00f3n ip, que seria la direccion local de la m\u00e1quina.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">int main(int argc, char **argv)\n{\n    if (argc != 2)\n    {\n        printf(\"Uso: %s \\n\", argv[0]);\n        return EXIT_FAILURE;\n    }\n \n    char *ip = \"127.0.0.1\"; \/\/direccion ip del servidor\n    int port = atoi(argv[1]); \/\/convierte string a int\n<\/pre>\n\n\n\n<p class=\"has-text-align-justify\">Nuevamente, estas son configuraciones habituales para usar sockets, no deber\u00eda haber mucho problema con esto.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">\/* Configuracion del Socket  *\/\n   listenfd = socket(AF_INET, SOCK_STREAM, 0);\n   serv_addr.sin_family = AF_INET;\n   serv_addr.sin_addr.s_addr = inet_addr(ip);\n   serv_addr.sin_port = htons(port);\n \n   if (setsockopt(listenfd, SOL_SOCKET, (SO_REUSEPORT | SO_REUSEADDR),\n       (char *)&amp;option, sizeof(option)) &lt; 0)\n   {\n       DieWithError(\"ERROR: setsockopt fall\u00f3\");\n   }\n \n   \/* Bind *\/\n   if (bind(listenfd, (struct sockaddr *)&amp;serv_addr, sizeof(serv_addr)) &lt; 0)\n   {\n       DieWithError(\"ERROR: El enlace de socket fall\u00f3\");\n   }\n \n   \/* Listen *\/\n   if (listen(listenfd, 10) &lt; 0)\n   {\n       DieWithError(\"ERROR: Fallo al abrir el socket\");\n   }<\/pre>\n\n\n\n<p>La siguiente parte del main, es un while infinito, que a trav\u00e9s de la funci\u00f3n \u201caccept\u201d est\u00e1 escuchando constantemente en el puerto, esperando siempre a nuevos clientes.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">while (1)\n   {\n       socklen_t clilen = sizeof(cli_addr);\n       connfd = accept(listenfd, (struct sockaddr *)&amp;cli_addr, &amp;clilen);\n<\/pre>\n\n\n\n<p>Una vez conecta con el cliente, comprueba si ya se llen\u00f3 la sala y es aqu\u00ed es donde decimos cu\u00e1l ser\u00e1 el l\u00edmite de usuarios con la variable \u201c MAX_CLIENTS\u201d. Es una variable global que definimos al principio del c\u00f3digo y con esta definimos el l\u00edmite de la sala. Esta vez son 100, pero podr\u00edan ser menos incluso m\u00e1s de 100. Si esta parte del codigo encuentra que ya se lleg\u00f3 a la m\u00e1xima capacidad la sala, simplemente desconecta el cliente y continua.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">       \/* Comprueba el maximo de clientes *\/\n       if ((cli_count + 1) == MAX_CLIENTS)\n       {\n           printf(\"Max clients reached. Rejected: \");\n           print_client_addr(cli_addr);\n           printf(\":%d\\n\", cli_addr.sin_port);\n           close(connfd);\n           continue;\n       }\n<\/pre>\n\n\n\n<p class=\"has-text-align-justify\">Luego de comprobar la conexi\u00f3n del cliente, se configura la estructura que definimos antes, guardando los datos importantes, como el socket, la direcci\u00f3n ip y el id del cliente, que en este caso simplemente es una variable incremental. Una vez definido esto, se agrega el cliente a la cola, se pasan por par\u00e1metros a un nuevo hilo dentro del servidor. Este hilo servir\u00e1 para manejar los mensajes entrantes del nuevo cliente.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">           \/* Configuracion del cliente aceptado *\/\n       client_t *cli = (client_t *)malloc(sizeof(client_t));\n       cli->address = cli_addr;\n       cli->sock = connfd;\n       cli->uid = uid++;\n \n       \/* Agrega el cliente a la cola y crea el hilo del cliente *\/\n       queue_add(cli);\n       pthread_create(&amp;tid, NULL, &amp;handle_client, (void *)cli);\n \n       \/* Reduce uso del CPU *\/\n       sleep(1);\n   }<\/pre>\n\n\n\n<h3>Funci\u00f3n handle_client<\/h3>\n\n\n\n<p class=\"has-text-align-justify\">Esta es una funci\u00f3n muy importante, ya que manejar\u00e1 los mensajes entrantes de todos los clientes nuevos en un hilo de proceso a parte. Esta parte del c\u00f3digo se encarga de recibir esos mensajes y enviarlos a los dem\u00e1s usuarios.\nEsta funci\u00f3n tambi\u00e9n es la encargada de detectar cuando el cliente se desconecte. Cuando esto sucede, el ciclo se corta a la vez que se elimina el cliente de la cola y cierra el hilo de proceso.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"c\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">while (1)\n{\n       if (leave_flag)\n       {\n           break;\n       }\n       memset(buff_out, 0, BUFFER_SZ); \/\/resetea el buffer de mensajes\n       int receive = recv(cli->sock, buff_out, BUFFER_SZ, 0);\n       if (receive > 0)\n       {\n           if (strlen(buff_out) > 0)\n           {\n               send_message(buff_out, cli->uid);\n               printf(\"%s\\n\", buff_out);\n           }\n       }\n       else if (receive == 0)\n       {\n           cli_count--;\n           sprintf(buff_out, \"%s se ha ido - %d conectados\\n\", cli->name, cli_count);\n           printf(\"%s\", buff_out);\n           send_message(buff_out, cli->uid);\n           leave_flag = 1;\n       }\n       else\n       {\n           printf(\"ERROR: -1\\n\");\n           leave_flag = 1;\n       }\n}\n<\/pre>\n\n\n\n<h3>Funciones restantes<\/h3>\n\n\n\n<p class=\"has-text-align-justify\"><strong>queue_add(client_t *cl) <\/strong>(agregar a la cola) Esta funci\u00f3n se encarga de a\u00f1adir a cada cliente nuevo a la cola de clientes, en un ciclo for comprueba un espacio libre desde el elemento cero. <\/p>\n\n\n\n<p class=\"has-text-align-justify\"><strong>queue_remove(int uid) <\/strong>(eliminar de la cola) Esta funci\u00f3n se encarga de eliminar a cada cliente que se desconecte, de la cola de clientes, en un ciclo for comprueba el uid del cliente desde el elemento cero para eliminarlo. <\/p>\n\n\n\n<p class=\"has-text-align-justify\"><strong>send_message(char *s, int uid) <\/strong>(enviar mensaje) Esta funci\u00f3n env\u00eda una copia de los mensajes entrantes a todos los clientes excepto al remitente, esto se hace comprobando en un ciclo for cada espacio v\u00e1lido de la cola evitando al uid del remitente.<\/p>\n\n\n\n<p>A continuaci\u00f3n en la <a href=\"https:\/\/ricardoromo.co\/2019\/sala-de-chat-en-c-para-100-usuarios-final\">parte final <\/a>del tutorial podr\u00e1n ver el resultado final del proyecto y su funcionamiento.<\/p>\n\n\n\n<div class=\"wp-block-uagb-buttons uagb-buttons__outer-wrap uagb-block-b88b3b8a\"><div class=\"uagb-buttons__wrap uagb-buttons-layout-wrap\">\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-02f052b1\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c\/\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 1<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-06d828ba\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c-cliente\/\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 2<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-1f6b6bb0\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c-servidor\/\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 3<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-bc874476\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/ricardoromo.co\/2019\/crea-una-servidor-de-sala-de-chat-en-c-final\" rel=\"noopener noreferrer\" target=\"_self\"><div class=\"uagb-button__link\">Parte 4<\/div><\/a><\/div><\/div>\n\n\n<div class=\"wp-block-uagb-buttons-child uagb-buttons__outer-wrap uagb-block-dfe5f7a7\"><div class=\"uagb-button__wrapper\"><a class=\"uagb-buttons-repeater\" href=\"https:\/\/github.com\/MrRomo\/C-Chatroom\" rel=\"noopener noreferrer\" target=\"_blank\"><div class=\"uagb-button__link\">Descargar c\u00f3digo<\/div><\/a><\/div><\/div>\n\n<\/div><\/div>\n","protected":false},"excerpt":{"rendered":"<p>Creando el Servidor El servidor en este proyecto, funciona como broker de mensajes, repartiendo los mensajes entre todos los clientes menos al emisor original. Es el encargado de decidir el puerto al cual se conectar\u00e1n los clientes. Funciones: Este c\u00f3digo del servidor ya es m\u00e1s complejo, ya que tiene que <a href=\"http:\/\/3.214.197.113\/2019\/crea-una-servidor-de-sala-de-chat-en-c-servidor\/\" class=\"read-more\">Seguir leyendo<i class=\"ion-ios-arrow-right read-more-right\"><\/i><\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"_mi_skip_tracking":false,"jetpack_publicize_message":"","jetpack_is_tweetstorm":false,"jetpack_publicize_feature_enabled":true,"jetpack_social_options":[]},"categories":[1],"tags":[6,22],"jetpack_publicize_connections":[],"aioseo_notices":[],"jetpack_featured_media_url":"","jetpack-related-posts":[{"id":1223,"url":"http:\/\/3.214.197.113\/2019\/crea-una-servidor-de-sala-de-chat-en-c\/","url_meta":{"origin":1832,"position":0},"title":"Como crear una Sala de Chat en C","date":"diciembre 6, 2019","format":false,"excerpt":"Aprende a programar una sala de chat hasta para 100 usuarios. Con el lenguaje C y las tecnologias de Sockets y Threads podras lograrlo.","rel":"","context":"En \u00abarticulo\u00bb","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/3.214.197.113\/wp-content\/uploads\/2019\/12\/network.jpg?fit=1200%2C675&resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1844,"url":"http:\/\/3.214.197.113\/2019\/crea-una-servidor-de-sala-de-chat-en-c-final\/","url_meta":{"origin":1832,"position":1},"title":"Como crear una Sala de Chat en C \u2013 Final","date":"diciembre 6, 2019","format":false,"excerpt":"Felicidades a todos los que llegaron hasta esta parte del tutorial, ahora vamos a ver en acci\u00f3n el proyecto final y como puedes ejecutarlo. Como saben dentro de los requisitos de este proyecto, era necesario tener un sistema linux ya que el programa utiliza librer\u00edas propias del sistema y en\u2026","rel":"","context":"En \u00abc\u00bb","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/3.214.197.113\/wp-content\/uploads\/2021\/07\/chat_resultado.jpg?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1822,"url":"http:\/\/3.214.197.113\/2019\/crea-una-servidor-de-sala-de-chat-en-c-cliente\/","url_meta":{"origin":1832,"position":2},"title":"Como crear una Sala de Chat en C \u2013 Cliente","date":"diciembre 6, 2019","format":false,"excerpt":"Creando el cliente El cliente es quien se conectar\u00e1 al servidor, quien enviar\u00e1 mensajes y recibir\u00e1 mensajes de otros clientes. En principio como debe ser una sala de chat. Librer\u00edas: Algunas de las librer\u00edas que estaremos utilizando seran estas: #include <stdio.h> - Contiene las definiciones de las macros, las constantes,\u2026","rel":"","context":"En \u00abc\u00bb","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/3.214.197.113\/wp-content\/uploads\/2021\/07\/Argumentos-del-sistema.jpg?resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1169,"url":"http:\/\/3.214.197.113\/2019\/como-crear-una-libreria-en-c-c\/","url_meta":{"origin":1832,"position":3},"title":"Como crear una Librer\u00eda en C\/C++","date":"diciembre 3, 2019","format":false,"excerpt":"Un tutorial muy sencillo y explicativo sobre como crear una libreria para nuestros proyectos de programacion con C y C++.","rel":"","context":"En \u00abarticulo\u00bb","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/3.214.197.113\/wp-content\/uploads\/2019\/12\/Fondo-HD.jpg?fit=1200%2C675&resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1849,"url":"http:\/\/3.214.197.113\/2020\/aprende-7-trucos-que-quizas-no-conocias-de-python\/","url_meta":{"origin":1832,"position":4},"title":"7 Trucos que deber\u00edas saber de Python","date":"agosto 28, 2020","format":false,"excerpt":"Aumenta tus habilidades de desarrollador con estos trucos en python que tal vez no conoc\u00edas y pueden ser muy \u00fatiles para tu d\u00eda a d\u00eda.","rel":"","context":"En \u00abarticulo\u00bb","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/3.214.197.113\/wp-content\/uploads\/2021\/07\/Banner-Horizontal-Trucos-en-python.png?fit=1200%2C675&resize=350%2C200","width":350,"height":200},"classes":[]},{"id":1195,"url":"http:\/\/3.214.197.113\/2018\/rbot-explorer-robot-autonomo\/","url_meta":{"origin":1832,"position":5},"title":"Un robot controlado a trav\u00e9s Internet","date":"noviembre 19, 2018","format":false,"excerpt":"Una de las revoluciones m\u00e1s notorias de nuestra \u00e9poca, es la conocida como Internet de las cosas (IoT, Internet of things), donde hay una tendencia a conectar todas nuestras actividades, electrodom\u00e9sticos y accesorios a Internet, d\u00e1ndole una funcionalidad e integraci\u00f3n entre ellos, que no podr\u00eda ser de otra manera. Por\u2026","rel":"","context":"En \u00abarticulo\u00bb","img":{"alt_text":"","src":"https:\/\/i0.wp.com\/3.214.197.113\/wp-content\/uploads\/2021\/07\/Modelo_Lateral-1.png?resize=350%2C200","width":350,"height":200},"classes":[]}],"_links":{"self":[{"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/posts\/1832"}],"collection":[{"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/comments?post=1832"}],"version-history":[{"count":0,"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/posts\/1832\/revisions"}],"wp:attachment":[{"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/media?parent=1832"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/categories?post=1832"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/3.214.197.113\/wp-json\/wp\/v2\/tags?post=1832"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}